---
title: "Homework3"
author: "Yicong Zeng"
format: pdf
editor: visual
---

## Set up

```{r}
#| message: false
library(tidyverse)
library(readxl)
library(here)
library(janitor)
library(GGally)
library(MuMIn)
library(ggeffects)
library(gtsummary)
library(flextable)
library(modelsummary)
library(gt)
drought_exp <- read_xlsx(path = here("data", 
                                     "Valliere_etal_EcoApps_Data.xlsx"),
                         sheet = "First Harvest")
```

## Problem 1: Multiple linear regression: model selection and construction

a.  Make a table or list of all the models from class and the last one you constructed on your own. Write a caption for your table.

### Cleaning

```{r}
drought_exp_clean <- drought_exp %>% 
  clean_names() %>% # nicer column names
  mutate(species_name = case_when( # adding column with species scientific names
    species == "ENCCAL" ~ "Encelia californica", # bush sunflower
    species == "ESCCAL" ~ "Eschscholzia californica", # California poppy
    species == "PENCEN" ~ "Penstemon centranthifolius", # Scarlet bugler
    species == "GRICAM" ~ "Grindelia camporum", # great valley gumweed
    species == "SALLEU" ~ "Salvia leucophylla", # Purple sage
    species == "STIPUL" ~ "Nasella pulchra", # Purple needlegrass
    species == "LOTSCO" ~ "Acmispon glaber" # deerweed
  )) %>% 
  relocate(species_name, .after = species) %>% # moving species_name column after species
  mutate(water_treatment = case_when( # adding column with full treatment names
    water == "WW" ~ "Well watered",
    water == "DS" ~ "Drought stressed"
  )) %>% 
  relocate(water_treatment, .after = water) # moving water_treatment column after water
```

### Table

**"Table 1. List of five Models. Each column in the table represent a different linear model that used to predict the total biomass. The row of the table include different combinations of predictors: specific leaf area, water treatment, and species name. Also, the second part of table shows the statistics of each models, include R2, R2 Adj., AIC, delta AIC, etc."**

```{r}
model0 <- lm(total_g ~ 1, # formula
             data = drought_exp_clean) # data frame

model1 <- lm(total_g ~ sla + water_treatment + species_name, # formula
             data = drought_exp_clean) # data frame

model2 <- lm(total_g ~ sla + water_treatment, # formula
             data = drought_exp_clean) # data frame

model3 <- lm(total_g ~ sla + species_name, # formula
             data = drought_exp_clean) # data frame

model4 <- lm(total_g ~ water_treatment + species_name, # formula
             data = drought_exp_clean) # data frame

modelsummary::modelsummary( # this function takes a list of models
  list( 
    "null" = model0, # "model name" = model object
    "model 1" = model1,
    "model 2" = model2,
    "model 3" = model3,
    "model 4" = model4
  )
)
```

b.  Write a 5-6 sentence “statistical methods” section. (8 points)

**"To examine the influence of specific leaf area(SLA), water treatment, and species on total biomass, I construct 5 different models. Specifically, the null model is not predicted by any of these variables, and saturated model utilize total biomass as a function of SLA, water treatment, and species. Other models include some combination of other predictors. To determine the model that best described total biomass, I create the model selection table to select the model with lowest AIC value. To evaluate linear model assumptions, I will look at the diagnostics for the model with the lowest AIC, including residual vs fitted, QQ residuals, scale-location, and residuals vs leverage."**

c.  Make a visualization of the model predictions with underlying data for your “best” model.

### model selection

```{r}
model.sel(model0,
          model1, 
          model2, 
          model3,
          model4)
```

**"The best model is model4 with lowest AICc"**

### model predictions

```{r}
#| warning: false
model_preds <- ggpredict(model4, 
                         terms = c("water_treatment", 
                                   "species_name"))

model_preds_for_plotting <- model_preds %>% 
  rename(water_treatment = x, # renaming columns to make this easier to use
         species_name = group) 

ggplot() +
  # underlying data
  geom_point(data = drought_exp_clean,
             aes(x = water_treatment,
                 y = total_g,
                 color = water_treatment),
             alpha = 0.5, size = 1.5) +
  # model prediction 95% CI ribbon
  geom_ribbon(data = model_preds_for_plotting,
              aes(x = water_treatment, 
                  y = predicted,
                  ymin = conf.low,
                  ymax = conf.high,
                  fill = water_treatment)) +
  # model prediction lines
  geom_line(data = model_preds_for_plotting,
            aes(x = water_treatment, 
                y = predicted,
                color = water_treatment)) +
  # cleaner theme
  theme_classic() +
  labs(title = "Preliminary Model Visualization",
      x = "Water Treatment",
      y = "Total Biomass (g)") +
  theme(panel.grid = element_blank(),
        strip.text = element_text(size = 9, face = "bold"), # Facet labels
        axis.text.x = element_text(size = 6), # Rotate x-axis text
        legend.position = "none") +# getting rid of gridlines
  # creating different panels for species
  facet_wrap(~species_name) 
```

d.  Write a caption for your visualization.

**"Figure 1: Model visualization of Total Biomass Predicted by Water Treatment and Species. The figure shows the predicted total biomass under well watered and drought stressed, and each facet represent different species. The rad and green dot indicate the well water and drought stress respectively. And The darkest dot in the plot represent the predicted value. Data source: Valliere, Justin; Zhang, Jacqueline; Sharifi, M.; Rundel, Philip (2019). Data from: Can we condition native plants to increase drought tolerance and improve restoration success? \[Dataset\]. Dryad. https://doi.org/10.5061/dryad.v0861f7"**

